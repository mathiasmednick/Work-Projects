{% extends "base.html" %}
{% block title %}Whiteboard â€“ {{ board.name|default:"Board" }}{% endblock %}

{% block page_header %}
<style>
.wb-toolrail { display: flex; flex-direction: column; gap: 0.25rem; padding: 0.5rem; background: #fff; border: 1px solid #dee2e6; border-radius: 8px; width: 48px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
.wb-toolrail button { width: 36px; height: 36px; border: 1px solid #dee2e6; border-radius: 4px; background: #f8f9fa; color: #212529; cursor: pointer; font-size: 1rem; }
.wb-toolrail button:hover { background: #e9ecef; }
.wb-toolrail button.active { background: #0d6efd; color: #fff; border-color: #0d6efd; }
.wb-canvas-wrap { display: flex; gap: 0.75rem; margin-top: 0.5rem; position: relative; }
.wb-canvas-outer { flex: 1; overflow: hidden; border: 1px solid #dee2e6; border-radius: 8px; background: #f8f9fa; position: relative; min-height: 500px; }
.wb-canvas-inner { position: absolute; left: 0; top: 0; min-width: 2000px; min-height: 1400px; }
.wb-canvas-inner.wb-bg-lines { background: linear-gradient(#e9ecef 1px, transparent 1px), linear-gradient(90deg, #e9ecef 1px, transparent 1px); background-size: 25px 25px; }
.wb-canvas-inner.wb-bg-grid { background-color: #f8f9fa; background-image: linear-gradient(#dee2e6 1px, transparent 1px), linear-gradient(90deg, #dee2e6 1px, transparent 1px); background-size: 20px 20px; }
.wb-bg-switch { position: relative; display: inline-flex; align-items: center; gap: 0.5rem; height: 26px; }
.wb-bg-switch .wb-bg-toggle { opacity: 0; width: 0; height: 0; }
.wb-bg-switch .wb-bg-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; width: 52px; height: 26px; background: #e9ecef; border-radius: 26px; transition: 0.3s; }
.wb-bg-switch .wb-bg-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background: #fff; border-radius: 50%; transition: 0.3s; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
.wb-bg-switch .wb-bg-toggle:checked + .wb-bg-slider { background: #0d6efd; }
.wb-bg-switch .wb-bg-toggle:checked + .wb-bg-slider:before { transform: translateX(26px); background: #fff; }
.wb-bg-switch span.wb-bg-label { margin-left: 56px; font-size: 0.875rem; color: #6c757d; }
.wb-item { position: absolute; border: 1px solid #dee2e6; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: move; background: #fff; overflow: hidden; color: #212529; transition: box-shadow 0.15s ease; }
.wb-item:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
.wb-item.note { background: #fff3cd; }
.wb-item.selected { outline: 2px solid #0d6efd; outline-offset: 1px; }
.wb-item.shape-rounded { border-radius: 12px; }
.wb-item.shape-circle { border-radius: 50%; }
.wb-item-content { padding: 0.4rem 0.6rem; font-size: 0.875rem; min-height: 100%; box-sizing: border-box; }
.wb-links-svg { position: absolute; left: 0; top: 0; pointer-events: none; width: 2000px; height: 1400px; }
.wb-toolrail { position: relative; }
.wb-toolrail button { transition: background 0.15s ease, border-color 0.15s ease, transform 0.1s ease; }
.wb-toolrail button:hover { transform: scale(1.05); }
.wb-canvas-inner { transform-origin: 0 0; transition: transform 0.05s ease-out; }
.wb-shapes-popover { position: absolute; left: 100%; top: 0; margin-left: 0.5rem; background: #fff; border: 1px solid #dee2e6; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.12); padding: 0.75rem; min-width: 200px; opacity: 0; visibility: hidden; transform: translateX(-8px); transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s; z-index: 50; }
.wb-shapes-popover.open { opacity: 1; visibility: visible; transform: translateX(0); }
.wb-shapes-row { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap: wrap; }
.wb-shapes-row:last-of-type { margin-bottom: 0; }
.wb-shape-btn { width: 36px; height: 36px; border: 1px solid #dee2e6; border-radius: 4px; background: #f8f9fa; color: #212529; cursor: pointer; font-size: 1rem; display: inline-flex; align-items: center; justify-content: center; transition: background 0.15s ease; }
.wb-shape-btn:hover { background: #e9ecef; }
.wb-shape-btn.active { background: #0d6efd; color: #fff; border-color: #0d6efd; }
</style>
<div class="page-header">
  <div>
    <h1 class="page-title">{{ board.name|default:"Board" }}</h1>
    <p class="page-subtitle">Select, add notes/text/boxes, connect items. Connector: click first item, then second. Pan: space+drag or Pan tool. Zoom: ctrl+wheel. Shapes: pick rectangle, rounded, circle, or line/arrow.</p>
  </div>
  <div class="page-header-actions" style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap;">
    <label class="wb-bg-switch" for="wb-bg-toggle" title="Switch canvas background">
      <input type="checkbox" class="wb-bg-toggle" id="wb-bg-toggle" aria-label="Grid background">
      <span class="wb-bg-slider"></span>
      <span class="wb-bg-label" id="wb-bg-label">Lines</span>
    </label>
    <select class="form-control" style="width: auto;" onchange="if(this.value) window.location=this.value;">
      {% for b in boards %}
      <option value="{% url 'whiteboard_board' board_id=b.id %}" {% if b.id == board.id %}selected{% endif %}>{{ b.name|default:"Unnamed" }}</option>
      {% endfor %}
    </select>
    <a href="{% url 'whiteboard' %}" class="btn btn-secondary">All boards</a>
  </div>
</div>
{% endblock %}

{% block content %}
<meta name="csrf-token" content="{{ csrf_token }}">
<script>
  window.wb = {
    boardId: {{ board.id }},
    canEdit: {{ can_edit|yesno:"true,false" }},
    csrf: document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
    urls: {
      itemCreate: "{% url 'whiteboard_item_create' board_id=board.id %}",
      itemUpdate: "{% url 'whiteboard_item_update' item_id=0 %}".replace('/0/', '/'),
      itemDelete: "{% url 'whiteboard_item_delete' item_id=0 %}".replace('/0/', '/'),
      linkCreate: "{% url 'whiteboard_link_create' board_id=board.id %}",
      linkDelete: "{% url 'whiteboard_link_delete' link_id=0 %}".replace('/0/', '/'),
    },
    items: {{ items_json|default:"[]" }},
    links: {{ links_json|default:"[]" }},
  };
</script>
<div class="wb-canvas-wrap">
  <div class="wb-toolrail" style="position: relative;">
    <button type="button" id="wb-tool-select" class="active" title="Select">&#128269;</button>
    <button type="button" id="wb-tool-pan" title="Pan">&#128274;</button>
    <button type="button" id="wb-tool-note" title="Sticky note">&#128203;</button>
    <button type="button" id="wb-tool-text" title="Text">T</button>
    <button type="button" id="wb-tool-box" title="Box">&#9633;</button>
    <button type="button" id="wb-tool-connector" title="Connector">&#8594;</button>
    <button type="button" id="wb-tool-shapes" title="Shapes">&#9638;</button>
    <div class="wb-shapes-popover" id="wb-shapes-popover">
      <div class="wb-shapes-row">
        <button type="button" class="wb-shape-btn" data-connector="plain" title="Line">&#9473;</button>
        <button type="button" class="wb-shape-btn" data-connector="arrow" title="Arrow">&#8594;</button>
      </div>
      <div class="wb-shapes-row">
        <button type="button" class="wb-shape-btn" data-shape="" data-type="box" title="Rectangle">&#9633;</button>
        <button type="button" class="wb-shape-btn" data-shape="rounded" data-type="box" title="Rounded">&#9643;</button>
        <button type="button" class="wb-shape-btn" data-shape="circle" data-type="box" title="Circle">&#9675;</button>
      </div>
    </div>
  </div>
  <div class="wb-canvas-outer" id="wb-canvas-outer">
    <div class="wb-canvas-inner wb-bg-lines" id="wb-canvas-inner">
      <svg class="wb-links-svg" id="wb-links-svg"></svg>
      <div id="wb-items-container"></div>
    </div>
  </div>
</div>
<script>
(function() {
  var boardId = window.wb.boardId;
  var canEdit = window.wb.canEdit;
  var csrf = window.wb.csrf;
  var urls = window.wb.urls;
  var items = window.wb.items.slice();
  var links = window.wb.links.slice();
  var activeTool = 'select';
  var currentShape = '';
  var linkStyle = 'arrow';
  var pan = { x: 0, y: 0, scale: 1 };
  var isPanning = false;
  var spacePressed = false;
  var panStart = { x: 0, y: 0 };
  var rafPending = false;
  var selectedItemId = null;
  var connectorFromId = null;
  var inner = document.getElementById('wb-canvas-inner');
  var outer = document.getElementById('wb-canvas-outer');
  var itemsContainer = document.getElementById('wb-items-container');
  var linksSvg = document.getElementById('wb-links-svg');

  function applyTransform() {
    inner.style.transform = 'translate(' + pan.x + 'px,' + pan.y + 'px) scale(' + pan.scale + ')';
    rafPending = false;
  }
  function updateCursor() {
    if (isPanning) outer.style.cursor = 'grabbing';
    else if (activeTool === 'pan' || spacePressed) outer.style.cursor = 'grab';
    else if (activeTool === 'note' || activeTool === 'text' || activeTool === 'box') outer.style.cursor = 'crosshair';
    else outer.style.cursor = 'default';
  }
  function screenToBoard(clientX, clientY) {
    var rect = outer.getBoundingClientRect();
    return {
      x: (clientX - rect.left - pan.x) / pan.scale,
      y: (clientY - rect.top - pan.y) / pan.scale
    };
  }
  function postJson(url, body, cb) {
    var fd = new FormData();
    fd.append('csrfmiddlewaretoken', csrf);
    for (var k in body) if (body.hasOwnProperty(k)) fd.append(k, body[k]);
    var req = new XMLHttpRequest();
    req.open('POST', url);
    req.setRequestHeader('X-CSRFToken', csrf);
    req.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
    req.onload = function() { if (cb) cb(req); };
    req.send(fd);
  }
  function renderItems() {
    itemsContainer.innerHTML = '';
    items.forEach(function(it) {
      var el = document.createElement('div');
      var typeClass = (it.type || 'note').toLowerCase();
      var shapeClass = (it.shape && it.shape !== '') ? ' shape-' + it.shape : '';
      el.className = 'wb-item ' + typeClass + shapeClass + (selectedItemId === it.id ? ' selected' : '');
      el.dataset.id = it.id;
      el.style.left = (it.x || 0) + 'px';
      el.style.top = (it.y || 0) + 'px';
      el.style.width = (it.w || 120) + 'px';
      el.style.height = (it.h || 80) + 'px';
      if (it.color) el.style.borderLeft = '4px solid ' + it.color;
      el.innerHTML = '<div class="wb-item-content" contenteditable="' + (canEdit ? 'true' : 'false') + '">' + (it.content || '').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>';
      if (canEdit) {
        el.addEventListener('pointerdown', function(e) {
          e.stopPropagation();
          if (activeTool === 'connector') {
            if (connectorFromId === null) connectorFromId = it.id;
            else {
              postJson(urls.linkCreate, { from_item_id: connectorFromId, to_item_id: it.id, style: linkStyle }, function(r) {
                if (r.status === 200) {
                  var d = JSON.parse(r.responseText);
                  links.push({ id: d.id, from_item_id: d.from_item_id, to_item_id: d.to_item_id, style: d.style || 'arrow' });
                  renderLinks();
                }
              });
              connectorFromId = null;
            }
            return;
          }
          selectedItemId = it.id;
          renderItems();
          if (activeTool === 'select') {
            var startX = e.clientX, startY = e.clientY, startLeft = it.x, startTop = it.y;
            function move(ev) {
              var dx = (ev.clientX - startX) / pan.scale, dy = (ev.clientY - startY) / pan.scale;
              it.x = startLeft + dx;
              it.y = startTop + dy;
              var itemEl = itemsContainer.querySelector('[data-id="' + it.id + '"]');
              if (itemEl) { itemEl.style.left = it.x + 'px'; itemEl.style.top = it.y + 'px'; }
            }
            function up(ev) {
              document.removeEventListener('pointermove', move);
              document.removeEventListener('pointerup', up);
              if (it.x !== startLeft || it.y !== startTop)
                postJson(urls.itemUpdate + it.id + '/', { x: it.x, y: it.y });
            }
            document.addEventListener('pointermove', move);
            document.addEventListener('pointerup', up);
          }
        });
        el.querySelector('.wb-item-content').addEventListener('blur', function() {
          it.content = this.textContent;
          postJson(urls.itemUpdate + it.id + '/', { content: it.content });
        });
      } else {
        el.addEventListener('click', function() { selectedItemId = it.id; renderItems(); });
      }
      itemsContainer.appendChild(el);
    });
  }
  function renderLinks() {
    var stroke = '#495057';
    var s = '';
    links.forEach(function(lk) {
      var fromIt = items.find(function(i) { return i.id === lk.from_item_id; });
      var toIt = items.find(function(i) { return i.id === lk.to_item_id; });
      if (!fromIt || !toIt) return;
      var x1 = fromIt.x + (fromIt.w || 120) / 2, y1 = fromIt.y + (fromIt.h || 80) / 2;
      var x2 = toIt.x + (toIt.w || 120) / 2, y2 = toIt.y + (toIt.h || 80) / 2;
      var marker = (lk.style === 'plain') ? '' : ' marker-end="url(#wb-arrow)"';
      s += '<line x1="' + x1 + '" y1="' + y1 + '" x2="' + x2 + '" y2="' + y2 + '" stroke="' + stroke + '" stroke-width="2"' + marker + '/>';
    });
    linksSvg.setAttribute('viewBox', '0 0 2000 1400');
    linksSvg.innerHTML = '<defs><marker id="wb-arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="' + stroke + '"/></marker></defs>' + s;
  }
  ['select', 'pan', 'note', 'text', 'box', 'connector'].forEach(function(t) {
    var btn = document.getElementById('wb-tool-' + t);
    if (btn) btn.addEventListener('click', function() {
      activeTool = t;
      document.querySelectorAll('.wb-toolrail > button').forEach(function(b) { b.classList.remove('active'); });
      this.classList.add('active');
      connectorFromId = null;
      document.getElementById('wb-shapes-popover').classList.remove('open');
      updateCursor();
    });
  });
  var shapesBtn = document.getElementById('wb-tool-shapes');
  var shapesPopover = document.getElementById('wb-shapes-popover');
  if (shapesBtn && shapesPopover) {
    shapesBtn.addEventListener('click', function() {
      shapesPopover.classList.toggle('open');
    });
  }
  document.querySelectorAll('.wb-shape-btn[data-type="box"]').forEach(function(btn) {
    btn.addEventListener('click', function() {
      activeTool = 'box';
      currentShape = this.getAttribute('data-shape') || '';
      document.querySelectorAll('.wb-toolrail > button').forEach(function(b) { b.classList.remove('active'); });
      if (shapesBtn) shapesBtn.classList.add('active');
      document.querySelectorAll('.wb-shape-btn').forEach(function(b) { b.classList.remove('active'); });
      this.classList.add('active');
      shapesPopover.classList.remove('open');
      updateCursor();
    });
  });
  document.querySelectorAll('.wb-shape-btn[data-connector]').forEach(function(btn) {
    btn.addEventListener('click', function() {
      activeTool = 'connector';
      linkStyle = this.getAttribute('data-connector') || 'arrow';
      document.querySelectorAll('.wb-toolrail > button').forEach(function(b) { b.classList.remove('active'); });
      document.getElementById('wb-tool-connector').classList.add('active');
      document.querySelectorAll('.wb-shape-btn').forEach(function(b) { b.classList.remove('active'); });
      this.classList.add('active');
      shapesPopover.classList.remove('open');
      updateCursor();
    });
  });
  document.addEventListener('keydown', function(e) { if (e.code === 'Space') { spacePressed = true; updateCursor(); } });
  document.addEventListener('keyup', function(e) { if (e.code === 'Space') { spacePressed = false; isPanning = false; updateCursor(); } });
  outer.addEventListener('pointerdown', function(e) {
    if (e.button === 1 || (e.button === 0 && (e.altKey || spacePressed)) || (e.button === 0 && activeTool === 'pan' && !e.target.closest('.wb-item'))) {
      isPanning = true;
      panStart = { x: e.clientX - pan.x, y: e.clientY - pan.y };
      e.preventDefault();
      updateCursor();
    } else if (e.button === 0 && activeTool !== 'select' && activeTool !== 'connector' && activeTool !== 'pan' && canEdit && !e.target.closest('.wb-item')) {
      var pt = screenToBoard(e.clientX, e.clientY);
      var type = activeTool === 'note' ? 'NOTE' : activeTool === 'text' ? 'TEXT' : 'BOX';
      var wasText = activeTool === 'text';
      var body = { type: type, x: pt.x, y: pt.y };
      if (type === 'BOX' && currentShape) body.shape = currentShape;
      postJson(urls.itemCreate, body, function(r) {
        if (r.status === 200) {
          var d = JSON.parse(r.responseText);
          if (d.shape === undefined) d.shape = '';
          items.push(d);
          renderItems();
          renderLinks();
          if (wasText && d.id) {
            var contentEl = itemsContainer.querySelector('[data-id="' + d.id + '"] .wb-item-content');
            if (contentEl) { contentEl.focus(); try { var sel = window.getSelection(); if (sel && contentEl.childNodes.length) sel.collapse(contentEl, 0); } catch (err) {} }
          }
        }
      });
    } else if (e.button === 0 && !e.target.closest('.wb-item')) { selectedItemId = null; renderItems(); }
  });
  outer.addEventListener('pointermove', function(e) {
    if (isPanning) {
      pan.x = e.clientX - panStart.x;
      pan.y = e.clientY - panStart.y;
      if (!rafPending) { rafPending = true; requestAnimationFrame(applyTransform); }
    }
  });
  outer.addEventListener('pointerup', function(e) { if (e.button === 1 || e.button === 0) { isPanning = false; updateCursor(); } });
  outer.addEventListener('wheel', function(e) {
    if (e.ctrlKey) {
      e.preventDefault();
      var factor = e.deltaY > 0 ? 0.9 : 1.1;
      pan.scale = Math.max(0.25, Math.min(3, pan.scale * factor));
      applyTransform();
    }
  }, { passive: false });
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Delete' && selectedItemId && canEdit) {
      var item = items.find(function(i) { return i.id === selectedItemId; });
      if (item) {
        postJson(urls.itemDelete + item.id + '/', {}, function(r) {
          if (r.status === 200) {
            items = items.filter(function(i) { return i.id !== item.id; });
            links = links.filter(function(l) { return l.from_item_id !== item.id && l.to_item_id !== item.id; });
            selectedItemId = null;
            renderItems();
            renderLinks();
          }
        });
      }
    }
  });
  (function initBgToggle() {
    var key = 'wb-bg-grid';
    var toggle = document.getElementById('wb-bg-toggle');
    var labelEl = document.getElementById('wb-bg-label');
    if (!inner || !toggle) return;
    function applyLayout() {
      inner.classList.remove('wb-bg-lines', 'wb-bg-grid');
      if (toggle.checked) { inner.classList.add('wb-bg-grid'); if (labelEl) labelEl.textContent = 'Grid'; try { localStorage.setItem(key, '1'); } catch (err) {} }
      else { inner.classList.add('wb-bg-lines'); if (labelEl) labelEl.textContent = 'Lines'; try { localStorage.removeItem(key); } catch (err) {} }
    }
    try {
      if (localStorage.getItem(key) === '1') { toggle.checked = true; }
      applyLayout();
    } catch (e) {}
    toggle.addEventListener('change', applyLayout);
    if (labelEl) labelEl.addEventListener('click', function(ev) {
      ev.preventDefault();
      toggle.checked = !toggle.checked;
      applyLayout();
    });
  })();
  updateCursor();
  applyTransform();
  renderItems();
  renderLinks();
})();
</script>
{% endblock %}
