{% extends "base.html" %}
{% load static %}
{% block title %}Whiteboard – {{ board.name|default:"Board" }}{% endblock %}

{% block page_header %}
<div class="page-header">
  <div>
    <h1 class="page-title">{{ board.name|default:"Board" }}</h1>
    <p class="page-subtitle">Drag cards to move. Edits save automatically.</p>
  </div>
  <div class="page-header-actions" style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
    <select id="board-select" class="form-control" style="width: auto; max-width: 200px;" onchange="if(this.value) window.location=this.value;">
      {% for b in boards %}
      <option value="{% url 'whiteboard_board' board_id=b.id %}" {% if b.id == board.id %}selected{% endif %}>{{ b.name|default:"Unnamed" }}</option>
      {% endfor %}
    </select>
    <a href="{% url 'whiteboard' %}" class="btn btn-secondary">All boards</a>
    <button type="button" class="btn btn-primary" id="add-card-btn">Add card</button>
  </div>
</div>
{% endblock %}

{% block content %}
<meta name="csrf-token" content="{{ csrf_token }}">
<script>
  window.whiteboardUrls = {
    move: "{% url 'whiteboard_card_move' card_id=0 %}".replace('/0/', '/'),
    update: "{% url 'whiteboard_card_update' card_id=0 %}".replace('/0/', '/'),
    delete: "{% url 'whiteboard_card_delete' card_id=0 %}".replace('/0/', '/'),
    create: "{% url 'whiteboard_card_create' board_id=board.id %}"
  };
</script>
<div id="whiteboard-container" style="position: relative; min-height: 520px; background: #f8f9fa; border: 1px solid var(--border-color); border-radius: 8px;">
  {% for card in cards %}
  <div class="whiteboard-card" data-id="{{ card.id }}" data-x="{{ card.x }}" data-y="{{ card.y }}"
       style="position: absolute; left: {{ card.x }}px; top: {{ card.y }}px; min-width: 180px; max-width: 280px; padding: 0; background: #fff; border: 1px solid var(--border-color); border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); {% if card.color %}border-left: 4px solid {{ card.color }};{% endif %}">
    <div class="whiteboard-card-header" style="padding: 0.4rem 0.6rem; background: #f1f3f5; border-radius: 6px 6px 0 0; cursor: move; display: flex; justify-content: space-between; align-items: center;">
      <span class="whiteboard-card-title" data-field="title" contenteditable="true" style="font-weight: 600; font-size: 0.875rem;">{{ card.display_title }}</span>
      <button type="button" class="whiteboard-card-delete" data-id="{{ card.id }}" style="background: none; border: none; cursor: pointer; padding: 0 0.25rem; font-size: 1rem; line-height: 1;" title="Delete">×</button>
    </div>
    <div class="whiteboard-card-body" data-field="body" contenteditable="true" style="padding: 0.5rem 0.75rem; font-size: 0.875rem; min-height: 2.5rem;">{{ card.body|default:card.text }}</div>
    {% if card.link_to_board %}
    <div style="padding: 0.25rem 0.75rem; font-size: 0.75rem;"><a href="{% url 'whiteboard_board' board_id=card.link_to_board_id %}">Open linked board →</a></div>
    {% endif %}
  </div>
  {% endfor %}
</div>

<script>
(function() {
  var container = document.getElementById('whiteboard-container');
  var boardId = {{ board.id }};
  var csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
  var csrfInput = function() { var i = document.createElement('input'); i.name = 'csrfmiddlewaretoken'; i.value = csrfToken; return i; };

  var urls = window.whiteboardUrls;
  function postForm(url, body, then) {
    var formData = new FormData();
    formData.append('csrfmiddlewaretoken', csrfToken);
    for (var k in body) if (body.hasOwnProperty(k)) formData.append(k, body[k]);
    var req = new XMLHttpRequest();
    req.open('POST', url);
    req.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
    req.setRequestHeader('X-CSRFToken', csrfToken);
    req.onload = function() { if (then) then(req); };
    req.send(formData);
  }

  // Pointer drag
  var dragging = null, startX = 0, startY = 0, startLeft = 0, startTop = 0;
  container.querySelectorAll('.whiteboard-card').forEach(function(card) {
    var header = card.querySelector('.whiteboard-card-header');
    if (!header) return;
    header.addEventListener('pointerdown', function(e) {
      if (e.button !== 0 || e.target.classList.contains('whiteboard-card-delete')) return;
      e.preventDefault();
      dragging = card;
      startX = e.clientX;
      startY = e.clientY;
      startLeft = parseInt(card.style.left, 10) || 0;
      startTop = parseInt(card.style.top, 10) || 0;
      card.setPointerCapture(e.pointerId);
    });
  });
  container.addEventListener('pointermove', function(e) {
    if (!dragging) return;
    e.preventDefault();
    var dx = e.clientX - startX, dy = e.clientY - startY;
    var x = Math.max(0, startLeft + dx), y = Math.max(0, startTop + dy);
    dragging.style.left = x + 'px';
    dragging.style.top = y + 'px';
    dragging.dataset.x = x;
    dragging.dataset.y = y;
  });
  container.addEventListener('pointerup', function(e) {
    if (dragging && e.button === 0) {
      var card = dragging;
      dragging = null;
      var x = parseInt(card.dataset.x, 10) || 0, y = parseInt(card.dataset.y, 10) || 0;
      postForm(urls.move + card.dataset.id + '/', { x: x, y: y });
    }
  });
  container.addEventListener('pointerleave', function(e) {
    if (dragging && e.buttons === 0) dragging = null;
  });

  // Update title/body on blur
  container.querySelectorAll('[contenteditable="true"]').forEach(function(el) {
    el.addEventListener('blur', function() {
      var card = el.closest('.whiteboard-card');
      if (!card) return;
      var field = el.dataset.field;
      postForm(urls.update + card.dataset.id + '/', { [field]: el.textContent.trim() });
    });
  });

  // Delete
  container.querySelectorAll('.whiteboard-card-delete').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var card = btn.closest('.whiteboard-card');
      if (!card || !confirm('Delete this card?')) return;
      postForm(urls.delete + card.dataset.id + '/', {}, function(req) {
        if (req.status >= 200 && req.status < 300) card.remove();
      });
    });
  });

  // Add card
  document.getElementById('add-card-btn').addEventListener('click', function() {
    postForm(urls.create, { x: 40, y: 40 }, function(req) {
      if (req.status !== 200) return;
      try {
        var r = JSON.parse(req.responseText);
        var card = document.createElement('div');
        card.className = 'whiteboard-card';
        card.dataset.id = r.id;
        card.dataset.x = r.x;
        card.dataset.y = r.y;
        card.style.cssText = 'position: absolute; left: ' + r.x + 'px; top: ' + r.y + 'px; min-width: 180px; max-width: 280px; padding: 0; background: #fff; border: 1px solid var(--border-color); border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.08);';
        card.innerHTML = '<div class="whiteboard-card-header" style="padding: 0.4rem 0.6rem; background: #f1f3f5; border-radius: 6px 6px 0 0; cursor: move; display: flex; justify-content: space-between;"><span class="whiteboard-card-title" data-field="title" contenteditable="true" style="font-weight: 600; font-size: 0.875rem;">New card</span><button type="button" class="whiteboard-card-delete" style="background: none; border: none; cursor: pointer;">×</button></div><div class="whiteboard-card-body" data-field="body" contenteditable="true" style="padding: 0.5rem 0.75rem; font-size: 0.875rem; min-height: 2.5rem;"></div>';
        container.appendChild(card);
        card.querySelector('.whiteboard-card-delete').addEventListener('click', function() {
          if (!confirm('Delete this card?')) return;
          postForm(urls.delete + card.dataset.id + '/', {}, function(rq) { if (rq.status >= 200 && rq.status < 300) card.remove(); });
        });
        card.querySelector('.whiteboard-card-title').addEventListener('blur', function() {
          postForm(urls.update + card.dataset.id + '/', { title: this.textContent.trim() });
        });
        card.querySelector('.whiteboard-card-body').addEventListener('blur', function() {
          postForm(urls.update + card.dataset.id + '/', { body: this.textContent.trim() });
        });
        var h = card.querySelector('.whiteboard-card-header');
        h.addEventListener('pointerdown', function(ev) {
          if (ev.button !== 0 || ev.target.classList.contains('whiteboard-card-delete')) return;
          ev.preventDefault();
          dragging = card;
          startX = ev.clientX;
          startY = ev.clientY;
          startLeft = parseInt(card.style.left, 10) || 0;
          startTop = parseInt(card.style.top, 10) || 0;
          card.setPointerCapture(ev.pointerId);
        });
      } catch (e) {}
    });
  });
})();
</script>
{% endblock %}
